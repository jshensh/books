{extend name="layout" /}

{block name="title"}闲鱼订单跟踪管理 - 账簿{/block}

{block name="content"}
        <a href="{:url('/goofish')->domain(true)}">< 返回列表</a>
        <p id="msg" style="display: none;"></p>
        <div id="logContainer"></div>
        <div id="GLOBAL_Container">
            <hr />
            <form action="" method="post" id="globalForm">
                {:token_field()}

                <p id="eventP"><label for="event">执行：</label><select name="event" id="event"></select></p>
                <p id="trusteeP"><label for="trustee">托管人：</label><select name="trustee" id="trustee"></select></p>
                <p id="nameP"><label for="name">资金对象：</label><select name="name" id="name"></select></p>
                <p id="currencyP"><label for="currency">交易币种：</label><select name="currency" id="currency"></select></p>
                <p id="moneyP"><label for="money">交易金额：<input type="text" name="money" id="money" autocomplete="off" /></label></p>
                <p id="noteP"><label for="note">附注：<input type="text" name="note" id="note" autocomplete="off" /></label></p>
                <p><input type="submit" value="提交" /></p>
            </form>
        </div>
        <div>
            <hr />
            <form action="" method="post" id="ROLLBACK_Container" style="display: none;">
                <input type="hidden" name="event" value="ROLLBACK" />
                {:token_field()}

                <input type="submit" value="回滚上一步" />&nbsp;&nbsp;&nbsp;
            </form>
            <form action="" method="post" id="CLOSE_Container" style="display: none;">
                <input type="hidden" name="event" value="CLOSE" />
                {:token_field()}

                <input type="submit" value="关闭订单" />
            </form>
            <p id="CLOSED_Container" style="display: none;">订单已关闭，无法进行任何操作</p>
        </div>
{/block}

{block name="javascript"}
    <script>
        var data = {:json_encode($data, JSON_UNESCAPED_UNICODE)};

        var newDom = function(tag, id, innerHTML, name, value) {
            var re = document.createElement(tag);
            id !== null && (re.id = id);
            name !== null && (re.name = name);
            value !== null && (re.value = value);
            innerHTML !== null && (tag === "optgroup" ? re.label = innerHTML : re.appendChild(typeof innerHTML === "object" ? innerHTML : document.createTextNode(innerHTML)));
            return re;
        };

        var formatMoney = function() {
            var dom = document.getElementById('money');
            var scale = data['currency'][document.getElementById('currency').value]['scale'];
            dom.value = dom.value.replace(/[^\d\.]/g, '').replace(/(\d)(\.)(\d*)(\2*)(\d*)/g, '$1$2$3$5');
            dom.value = dom.value ? parseFloat(dom.value).toFixed(scale) : '';
        };

        window.onload = function() {
            var msg = data['msg'];
            
            if (msg) {
                document.getElementById('msg').innerHTML = `${msg}<hr/ >`;
                document.getElementById('msg').style["display"] = "block";
            }

            var log = [];
            for (var i = 0; i < data['data'].length; i++) {
                var currentCurrency = data['data'][i]['transactmode_id'] ? data['currency'][data['transactmode'][data['data'][i]['transactmode_id']]['currency_code']] : null;
                switch (data['data'][i]['event']) {
                    case 'CREATE':
                        log.push(`<li>[${data['data'][i]['created_at']}] ${data['data'][i]['event']}<br />创建订单</li>`);
                        break;
                    case 'ORDER_INCOME':
                        log.push(`<li>[${data['data'][i]['created_at']}] ${data['data'][i]['event']}${data['data'][i]['is_rollback'] ? '<span style="color: red;">（回滚）</span>' : ''}<br />${data['data'][i]['trustee'] ? (data['data'][i]['name'] ? data['data'][i]['trustee'] : '自有资金 代 ' + data['data'][i]['trustee'] + ' ') : (data['data'][i]['name'] ? '自有资金' : '')}${(data['data'][i]['name'] ? ' 经 ' + data['data'][i]['name'] + ' 代收' : ' ')}收入 ${currentCurrency.symbol}${parseFloat(data['data'][i]['money']).toFixed(currentCurrency.scale)}${currentCurrency.unit_name ? ' ' + currentCurrency.unit_name : ''}${data['data'][i]['note'] ? '<br />附注：' + data['data'][i]['note'] : ''}</li>`);
                        break;
                    case 'ORDER_REFUND':
                    case 'SHIP_FEE_OUT':
                    case 'SHIP_FEE_RETURN':
                    case 'PLATFORM_FEE':
                        log.push(`<li>[${data['data'][i]['created_at']}] ${data['data'][i]['event']}${data['data'][i]['is_rollback'] ? '<span style="color: red;">（回滚）</span>' : ''}<br />${data['data'][i]['trustee'] ? (data['data'][i]['name'] ? data['data'][i]['trustee'] : '自有资金 代 ' + data['data'][i]['trustee'] + ' ') : (data['data'][i]['name'] ? '自有资金' : '')}${(data['data'][i]['name'] ? ' 经 ' + data['data'][i]['name'] + ' 代付' : ' ')}支出 ${currentCurrency.symbol}${parseFloat(data['data'][i]['money']).toFixed(currentCurrency.scale)}${currentCurrency.unit_name ? ' ' + currentCurrency.unit_name : ''}${data['data'][i]['note'] ? '<br />附注：' + data['data'][i]['note'] : ''}</li>`);
                        break;
                    case 'ROLLBACK':
                        log.push(`<li>[${data['data'][i]['created_at']}] ${data['data'][i]['event']}<br />回滚交易${data['data'][i]['note'] ? '<br />附注：' + data['data'][i]['note'] : ''}</li>`);
                        break;
                    case 'CLOSE':
                        log.push(`<li>[${data['data'][i]['created_at']}] ${data['data'][i]['event']}<br />结束订单</li>`);
                        break;
                }
            }
            document.getElementById('logContainer').innerHTML = `订单 ${data['data'][0]['order_no']} 跟踪状态：<br /><ul>${log.join('')}</ul>`;

            document.getElementById('name').appendChild(newDom("option", null, '自有资金', null, ''));
            document.getElementById('trustee').appendChild(newDom("option", null, '自有物品', null, ''));

            for (var j = 0; j < data['loanUser'].length; j++) {
                document.getElementById('name').appendChild(newDom("option", null, data['loanUser'][j], null, data['loanUser'][j]));
                document.getElementById('trustee').appendChild(newDom("option", null, data['loanUser'][j], null, data['loanUser'][j]));
            }
            var tmpOptionDom = newDom("option", null, '新建', null, '');
            tmpOptionDom.setAttribute('data-create', 'true');
            document.getElementById('name').appendChild(tmpOptionDom);

            document.getElementById('name').addEventListener('change', function() {
                if (this.options[this.options.selectedIndex].getAttribute('data-create') === 'true') {
                    document.getElementById('nameP').innerHTML = '';
                    var labelDom = newDom('label', null, '资金对象：');
                    labelDom.appendChild(newDom('input', null, null, this.id, ''));
                    document.getElementById('nameP').appendChild(labelDom);
                }
            });

            var tmpOptionDom2 = newDom("option", null, '新建', null, '');
            tmpOptionDom2.setAttribute('data-create', 'true');
            document.getElementById('trustee').appendChild(tmpOptionDom2);

            document.getElementById('trustee').addEventListener('change', function() {
                if (this.options[this.options.selectedIndex].getAttribute('data-create') === 'true') {
                    document.getElementById('trusteeP').innerHTML = '';
                    var labelDom = newDom('label', null, '托管人：');
                    labelDom.appendChild(newDom('input', null, null, this.id, ''));
                    document.getElementById('trusteeP').appendChild(labelDom);
                }
            });

            var eventLabelMap = {
                'ORDER_INCOME':    '追加商品明细',
                'ORDER_REFUND':    '追加商品退款',
                'SHIP_FEE_OUT':    '录入寄出运费',
                'SHIP_FEE_RETURN': '录入退货运费',
                'PLATFORM_FEE':    '录入平台服务费',
            };
            
            for (var i = 0; i < data['allowedNextEvent'].length; i++) {
                switch (data['allowedNextEvent'][i]) {
                    case 'ORDER_INCOME':
                    case 'ORDER_REFUND':
                    case 'SHIP_FEE_OUT':
                    case 'SHIP_FEE_RETURN':
                    case 'PLATFORM_FEE':
                        document.getElementById('event').appendChild(newDom("option", null, eventLabelMap[data['allowedNextEvent'][i]], null, data['allowedNextEvent'][i]));
                        break;
                    case 'CLOSED':
                        document.getElementById(`${data['allowedNextEvent'][i]}_Container`).style['display'] = 'block';
                        document.getElementById('GLOBAL_Container').style['display'] = 'none';
                        break;
                    case 'ROLLBACK':
                    case 'CLOSE':
                        document.getElementById(`${data['allowedNextEvent'][i]}_Container`).style['display'] = 'inline';
                        break;
                }
            }

            document.getElementById('noteP').style['display'] = (document.getElementById('event').value === 'PLATFORM_FEE' ? 'none' : 'block');

            document.getElementById('event').addEventListener('change', function() {
                document.getElementById('noteP').style['display'] = (this.value === 'PLATFORM_FEE' ? 'none' : 'block');
            });

            for (var j in data['currency']) {
                document.getElementById('currency').appendChild(newDom("option", null, `${data['currency'][j]['name']} ${data['currency'][j]['code']}`, null, data['currency'][j]['code']));
            }
        };
    </script>
{/block}

{block name="css"}
    <style>
        p {
            margin: 5px 0
        }
        
        ul {
            margin: 0;
            padding-left: 30px;
        }

        ul li {
            padding-top: 5px;
        }
    </style>
{/block}
